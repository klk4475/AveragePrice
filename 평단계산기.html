<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>평단 계산기</title>
  <style>
    :root{font-family:system-ui,-apple-system,"Segoe UI",Roboto,'Noto Sans KR',sans-serif;color:#0f172a}
    body{background:#f8fafc;padding:18px;margin:0;display:flex;justify-content:center}
    .card{max-width:760px;width:100%;margin:18px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 12px;color:#475569;font-size:13px} /* 폰트 크기 축소 */
    table{width:100%;border-collapse:collapse;margin-bottom:8px}
    th,td{padding:8px;text-align:left;vertical-align:middle}
    th{font-weight:700;color:#0f172a}
    .col-label{width:24%}
    input[type="text"], input[type="number"]{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px;box-sizing:border-box}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:#0ea5a3;color:white}
    .btn-ghost{background:#eef2ff;color:#3730a3}
    .btn-toggle{background:#f1f5f9;color:#0f172a;padding:8px 12px;border-radius:8px}
    .result{background:#0f172a;color:white;padding:12px;border-radius:10px;margin-top:12px;white-space:pre-wrap}
    .small{font-size:13px;color:#64748b}
    .right{margin-left:auto}
    .note{font-size:13px;color:#475569;margin-top:8px}
    .error{color:#b91c1c;font-weight:700}
    .ratio-panel{position:absolute;display:flex;gap:6px;background:#ffffff;padding:6px;border-radius:8px;box-shadow:0 6px 18px rgba(15,23,42,0.08);z-index:50}
    .ratio-panel button{padding:6px 8px;border-radius:6px;background:#eef2ff;border:0;cursor:pointer}
    .row-wrap{position:relative}
    .mode-indicator{display:inline-block;padding:6px 8px;border-radius:8px;background:#f8fafc;border:1px dashed #cbd5e1;color:#334155;font-weight:700}
    .bottom-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
    /* Add/Remove Button Style */
    .btn-action{padding:6px 10px;border-radius:6px;font-size:18px;line-height:1;width:30px;height:30px;display:flex;justify-content:center;align-items:center}
    .btn-add{background:#d1fae5;color:#065f46} /* Green for Add/Currency Calc */
    .btn-remove{background:#fee2e2;color:#991b1b}
    .btn-currency{background:#d1fae5;color:#065f46;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700} /* Updated style for currency toggle */
    @media(max-width:640px){.col-label{display:block;width:100%} .right{margin-left:0}}
  </style>
</head>
<body>
  <div class="card">
    <h1>평단 계산기</h1> <p class="lead">1차 매수 + 추가 매수 계산. 수량/금액 모드 전환 가능. 롱/숏 모드 전환 가능.</p> <table>
      <thead>
        <tr>
          <th class="col-label">매수구분</th>
          <th id="priceHeader">가격 (${currencyUnit()})</th>
          <th id="qtyHeader">수량 <small class="small" style="color:#94a3b8;cursor:pointer" title="클릭하면 금액(${currencyUnit()}) 모드로 전환">(클릭해 금액모드)</small></th>
        </tr>
      </thead>
      <tbody id="tbody">
        </tbody>
    </table>

    <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
      <label style="font-weight:700">현재가 (선택)</label>
      <input id="cur" type="text" placeholder="예: 13,500" style="max-width:160px" />
      <div class="right" style="margin-left:auto;display:flex;gap:8px">
        <button id="addRowBtn" class="btn-action btn-add">+</button>
        <button id="removeRowBtn" class="btn-action btn-remove">-</button>
        <button id="calcBtn" class="btn-primary">계산</button>
        <button id="resetBtn" class="btn-ghost">초기화</button>
      </div>
    </div>

    <div id="error" class="error" style="display:none;margin-top:8px"></div>
    <div id="result" class="result" style="display:none"></div>

    <div class="bottom-actions">
      <div style="display:flex;gap:8px">
        <button id="copyBtn" class="btn-ghost">결과 복사</button>
        <button id="toggleCurrency" class="btn-currency">달러($)로 계산</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="mode-indicator" id="modeLabel">모드: 롱</div>
        <button id="toggleMode" class="btn-toggle">롱 ↔ 숏 전환</button>
      </div>
    </div>

    <p class="note">팁: 수량(또는 금액)이 0 또는 빈칸이면 해당 매수는 계산에서 제외됩니다. 사이드 버튼(비율)은 입력창에 커서를 올리면 표시됩니다. **1차 매수**는 비율 버튼이 표시되지 않습니다.</p>
  </div>

  <script>
    // 상태
    let isMoneyMode = false; // false = 수량 모드, true = 금액 모드
    let isShortMode = false; // false = Long, true = Short
    let isDollarMode = false; // false = 원(KRW), true = 달러(USD)

    const tbody = document.getElementById('tbody');
    const qtyHeader = document.getElementById('qtyHeader');
    const priceHeader = document.getElementById('priceHeader');
    const modeLabel = document.getElementById('modeLabel');
    const toggleCurrencyBtn = document.getElementById('toggleCurrency');

    // 통화 단위 반환 함수
    function currencyUnit(isShort = false) {
      if (isDollarMode) {
        return isShort ? '$' : 'USD';
      } else {
        return isShort ? '원' : 'KRW';
      }
    }

    // 초기 ROWS: 1차 매수 ~ 5차 매수로 변경
    let ROWS = [
      {id: 1, label: '1차 매수'},
      {id: 2, label: '2차 매수'},
      {id: 3, label: '3차 매수'},
      {id: 4, label: '4차 매수'},
      {id: 5, label: '5차 매수'}
    ];
    let nextRowId = 6;
    const MAX_ROWS = 10;
    const MIN_ROWS = 5;

    function updateHeaderLabels() {
      const unit = currencyUnit(true);
      const unitFull = currencyUnit();
      priceHeader.innerHTML = `가격 (${unit})`;
      qtyHeader.innerHTML = isMoneyMode ? `금액 (${unit}) <small class="small" style="color:#94a3b8;cursor:pointer">(클릭해 수량모드)</small>` : `수량 <small class="small" style="color:#94a3b8;cursor:pointer">(클릭해 금액모드)</small>`;
      
      // 설명 텍스트 업데이트 (단축된 버전)
      document.querySelector('p.lead').innerHTML = `1차 매수 + 추가 매수 계산. 수량/금액 모드 전환 가능. 롱/숏 모드 전환 가능.`;
      
      // Update placeholders
      ROWS.forEach(r => {
        const el = document.getElementById(`qty_${r.id}`);
        if(el) el.placeholder = isMoneyMode ? `금액(${unit})` : '수량';
      });
      document.getElementById('cur').placeholder = isDollarMode ? '예: 13.5' : '예: 13,500';
    }


    function createRows(){
      tbody.innerHTML = '';
      ROWS.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'row-wrap';
        tr.setAttribute('data-id', r.id);
        tr.innerHTML = `
          <td style="width:24%">${r.label}</td>
          <td style="width:38%"><input type="text" id="price_${r.id}" placeholder="${isDollarMode ? '예: 13.5' : '예: 12,000'}" /></td>
          <td style="width:38%">
            <div style="display:flex;gap:8px;align-items:center;position:relative">
              <input type="text" id="qty_${r.id}" placeholder="${isMoneyMode ? `금액(${currencyUnit(true)})` : '수량'}" />
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
      attachBehaviors();
      updateHeaderLabels();
    }

    // 소수점 처리 함수 (정수이거나 소수점 2자리까지만 표시)
    function formatResultNum(num) {
      if (isNaN(num)) return '';
      const rounded = Math.round(num * 100) / 100; // 소수점 2자리까지만 반올림
      if (rounded % 1 === 0) {
        return Math.round(rounded).toLocaleString();
      } else {
        return rounded.toFixed(2).toLocaleString();
      }
    }

    function formatNum(s){
      if(s==null) return '';
      return String(s).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function parseNum(s){
      if(s==null) return NaN;
      const t = String(s).trim().replace(/,/g,'');
      if(t === '') return NaN;
      if(!/^[-+]?\d*(?:\.\d+)?$/.test(t)) return NaN;
      return parseFloat(t);
    }

    // attach focus behaviors for ratio buttons and keep track of values
    function attachBehaviors(){
      ROWS.forEach((r) => {
        const qtyEl = document.getElementById(`qty_${r.id}`);
        const priceEl = document.getElementById(`price_${r.id}`);

        qtyEl.placeholder = isMoneyMode ? `금액(${currencyUnit(true)})` : '수량';

        // show ratio panel on focus
        qtyEl.addEventListener('focus', (e)=>{
          // 1차 매수(id=1)에서는 비율 버튼을 표시하지 않음
          if(r.id !== 1) showRatioPanel(r.id);
        });
        qtyEl.addEventListener('blur', (e)=>{
          // hide after small delay to allow click on panel
          setTimeout(()=>{ hideRatioPanel(r.id); }, 200);
        });

        // 포맷팅: 입력 도중엔 포맷하지 않음 (사용자 편의)
        priceEl.addEventListener('blur', ()=>{
          const v = parseNum(priceEl.value);
          if(!isNaN(v)) {
            // 원화 모드에서만 정수로 반올림 후 포맷
            if(!isDollarMode) priceEl.value = formatNum(Math.round(v));
            else priceEl.value = formatNum(v);
          }
        });
        qtyEl.addEventListener('blur', ()=>{
          const v = parseNum(qtyEl.value);
          if(!isNaN(v)) {
            // 금액모드이면 정수 단위로 포맷
            if(isMoneyMode) qtyEl.value = formatNum(Math.round(v));
            else qtyEl.value = v % 1 === 0 ? String(Math.round(v)) : String(v);
          }
        });
      });
    }

    function getRowIndexById(id){
      return ROWS.findIndex(r => r.id === id);
    }

    function showRatioPanel(rowId){
      hideAllRatioPanels();
      const tr = tbody.querySelector(`tr[data-id="${rowId}"]`);
      if(!tr) return;
      const wrapper = tr.querySelector('td:nth-child(3) > div');
      const panel = document.createElement('div');
      panel.className = 'ratio-panel';
      panel.style.top = '46px';
      panel.style.right = '0px';
      panel.innerHTML = `
        <button data-r="1">1:1</button>
        <button data-r="2">1:2</button>
        <button data-r="3">1:3</button>
        <button data-r="4">1:4</button>
      `;
      wrapper.appendChild(panel);

      panel.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          const r = parseInt(btn.getAttribute('data-r'));
          applyRatio(rowId, r);
          // keep focus
          const q = document.getElementById(`qty_${rowId}`);
          q.focus();
        });
      });
    }
    function hideRatioPanel(rowId){
      const tr = tbody.querySelector(`tr[data-id="${rowId}"]`);
      if(!tr) return;
      const wrapper = tr.querySelector('td:nth-child(3) > div');
      const panel = wrapper.querySelector('.ratio-panel');
      if(panel) panel.remove();
    }
    function hideAllRatioPanels(){
      document.querySelectorAll('.ratio-panel').forEach(p=>p.remove());
    }

    // apply ratio: find 직전 매수 (이전 인덱스에서 값이 있는 것)
    function applyRatio(targetId, ratio){
      const targetIdx = getRowIndexById(targetId);
      // find previous non-empty entry before targetIdx
      let baseIdx = null;
      for(let i=targetIdx-1;i>=0;i--){
        const qv = parseNum(document.getElementById(`qty_${ROWS[i].id}`).value);
        if(!isNaN(qv) && qv !== 0) { baseIdx = i; break; }
      }
      if(baseIdx === null){
        for(let i=0;i<targetIdx;i++){
          const qv = parseNum(document.getElementById(`qty_${ROWS[i].id}`).value);
          if(!isNaN(qv) && qv !== 0){ baseIdx = i; break; }
        }
      }

      const targetQtyEl = document.getElementById(`qty_${targetId}`);
      if(baseIdx === null){
        if(isMoneyMode){
          targetQtyEl.value = formatNum(ratio);
        } else {
          targetQtyEl.value = ratio;
        }
        return;
      }

      const baseQtyVal = parseNum(document.getElementById(`qty_${ROWS[baseIdx].id}`).value);
      const basePriceVal = parseNum(document.getElementById(`price_${ROWS[baseIdx].id}`).value);

      if(isMoneyMode){
        let baseMoney = !isNaN(baseQtyVal) && baseQtyVal !== 0 ? baseQtyVal : ( (!isNaN(basePriceVal) ? basePriceVal : 0) );
        targetQtyEl.value = formatNum(Math.round(baseMoney * ratio));
      } else {
        if(!isNaN(baseQtyVal) && baseQtyVal !== 0){
          targetQtyEl.value = (baseQtyVal * ratio).toString();
        } else if(!isNaN(basePriceVal) && basePriceVal!==0){
          targetQtyEl.value = (1 * ratio).toString();
        } else {
          targetQtyEl.value = (1 * ratio).toString();
        }
      }
    }

    // toggle money/qty mode when header clicked
    qtyHeader.addEventListener('click', ()=>{
      isMoneyMode = !isMoneyMode;
      updateHeaderLabels();
      ROWS.forEach(r => {
        const el = document.getElementById(`qty_${r.id}`);
        if(el) el.placeholder = isMoneyMode ? `금액(${currencyUnit(true)})` : '수량';
      });
    });

    // toggle currency mode
    toggleCurrencyBtn.addEventListener('click', () => {
      isDollarMode = !isDollarMode;
      toggleCurrencyBtn.textContent = isDollarMode ? '원(KRW)으로 계산' : '달러($)로 계산';
      updateHeaderLabels();
      calculate(); // Recalculate to update display format
    });

    // toggle long/short
    document.getElementById('toggleMode').addEventListener('click', ()=>{
      isShortMode = !isShortMode;
      modeLabel.textContent = isShortMode ? '모드: 숏' : '모드: 롱';
      calculate();
    });

    // Add Row functionality
    document.getElementById('addRowBtn').addEventListener('click', () => {
      if(ROWS.length >= MAX_ROWS) return alert(`최대 ${MAX_ROWS}차 매수까지만 가능합니다.`);

      const newId = nextRowId++;
      const newRow = {id: newId, label: `${newId}차 매수`};
      ROWS.push(newRow);

      const tr = document.createElement('tr');
      tr.className = 'row-wrap';
      tr.setAttribute('data-id', newId);
      tr.innerHTML = `
        <td style="width:24%">${newRow.label}</td>
        <td style="width:38%"><input type="text" id="price_${newId}" placeholder="${isDollarMode ? '예: 13.5' : '예: 12,000'}" /></td>
        <td style="width:38%">
          <div style="display:flex;gap:8px;align-items:center;position:relative">
            <input type="text" id="qty_${newId}" placeholder="${isMoneyMode ? `금액(${currencyUnit(true)})` : '수량'}" />
          </div>
        </td>
      `;
      tbody.appendChild(tr);
      attachBehaviors();
    });

    // Remove Row functionality
    document.getElementById('removeRowBtn').addEventListener('click', () => {
      if(ROWS.length <= MIN_ROWS) return alert(`${MIN_ROWS}차 매수(5차 매수)부터는 삭제할 수 없습니다.`);

      const lastRow = ROWS.pop();
      const tr = tbody.querySelector(`tr[data-id="${lastRow.id}"]`);
      if(tr) tr.remove();

      if(lastRow.id === nextRowId - 1) nextRowId--;

      hideAllRatioPanels();
    });

    // calculation
    document.getElementById('calcBtn').addEventListener('click', calculate);
    document.getElementById('resetBtn').addEventListener('click', ()=>{ 
      document.querySelectorAll('input').forEach(i=>i.value=''); 
      document.getElementById('result').style.display='none'; 
      document.getElementById('error').style.display='none'; 
    });

    document.getElementById('copyBtn').addEventListener('click', ()=>{
      const txt = document.getElementById('result').textContent || '';
      if(!txt) return alert('복사할 결과가 없습니다.');
      navigator.clipboard.writeText(txt).then(()=>alert('결과가 복사되었습니다.')).catch(()=>alert('복사 실패'));
    });

    function calculate(){
      hideAllRatioPanels();
      document.getElementById('error').style.display='none';
      try{
        let totalQty = 0; // 실제 수량
        let totalValue = 0; // 총 매수금액 (원/달러)
        const details = [];

        ROWS.forEach(r => {
          const p = parseNum(document.getElementById(`price_${r.id}`).value);
          const qraw = parseNum(document.getElementById(`qty_${r.id}`).value);

          if(isNaN(p) || p <= 0){
            if(isNaN(qraw) || qraw===0) return;
            throw new Error(`${r.label}의 가격을 정확히 입력하세요.`);
          }

          if(isNaN(qraw) || qraw===0) return;

          let qty = 0, value = 0;
          if(isMoneyMode){
            value = qraw;
            qty = value / p;
          } else {
            qty = qraw;
            value = qty * p;
          }

          totalQty += qty;
          totalValue += value;

          details.push({label: r.label, price:p, qty:qty, value:value});
        });

        if(totalQty === 0){
          throw new Error('수량(또는 금액)이 입력된 매수가 없습니다. 최소 하나를 입력하세요.');
        }

        const avgPrice = totalValue / totalQty;
        const curRaw = parseNum(document.getElementById('cur').value);
        const hasCur = !isNaN(curRaw) && curRaw !== 0;

        const unit = currencyUnit(true); // '원' or '$'

        let lines = [];
        lines.push(`총 매수 횟수: ${details.length}`);
        lines.push(`총 수량: ${totalQty % 1 === 0 ? totalQty.toFixed(0) : totalQty.toFixed(6)}`);
        
        // 총 매수 금액 포맷 (소수점 2자리 또는 정수)
        const formattedTotalValue = formatResultNum(totalValue);
        lines.push(`총 매수금액: ${formattedTotalValue} ${unit}`);
        lines.push(`평단가: ${avgPrice.toFixed(6)} ${unit}`);

        if(hasCur){
          const cur = curRaw;
          let profitPerUnit, profitPercent, totalProfit;
          if(isShortMode){
            profitPerUnit = avgPrice - cur;
          } else {
            profitPerUnit = cur - avgPrice;
          }
          profitPercent = (profitPerUnit / avgPrice) * 100;
          totalProfit = profitPerUnit * totalQty;

          lines.push('');
          
          // 현재가 포맷 (소수점 2자리 또는 정수)
          const formattedCur = formatResultNum(cur);
          lines.push(`현재가: ${formattedCur} ${unit}`);
          
          const formattedProfitPerUnit = profitPerUnit.toFixed(6); // 단위당 손익은 6자리 유지
          lines.push(isShortMode ? `숏 기준 단위당 손익: ${formattedProfitPerUnit} ${unit} (${profitPercent.toFixed(4)}%)` : `롱 기준 단위당 손익: ${formattedProfitPerUnit} ${unit} (${profitPercent.toFixed(4)}%)`);
          
          // 총 손익 포맷 (소수점 2자리 또는 정수) 및 부호 추가
          const formattedTotalProfitValue = formatResultNum(Math.abs(totalProfit));
          const totalProfitSign = totalProfit >= 0 ? '+' : ''; // 0 또는 양수일 때 '+' 표시
          
          lines.push(`총 손익: ${totalProfitSign}${totalProfit < 0 ? '-' : ''}${formattedTotalProfitValue} ${unit}`);
        }

        lines.push('');
        lines.push('--- 상세 매수 ---');
        details.forEach(d=>{
          // 상세 매수 금액/가격 포맷 (소수점 2자리 또는 정수)
          const formattedPrice = formatResultNum(d.price);
          const formattedValue = formatResultNum(d.value);
          const formattedQty = d.qty % 1 ===0 ? d.qty.toFixed(0) : d.qty.toFixed(6);
          lines.push(`${d.label}  가격: ${formattedPrice} ${unit}  수량: ${formattedQty}  (합계: ${formattedValue} ${unit})`);
        });

        const resultEl = document.getElementById('result');
        resultEl.style.display = 'block';
        resultEl.textContent = lines.join('\n');

      }catch(err){
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.textContent = err.message || String(err);
        document.getElementById('result').style.display='none';
      }
    }

    // init
    createRows();

    // close panels when clicking outside
    document.addEventListener('click',(e)=>{
      if(!e.target.closest('.ratio-panel') && !e.target.closest('input')) hideAllRatioPanels();
    });

  </script>
</body>
</html>